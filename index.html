<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>足球盘口管理系统 - 管理平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #1e3c72;
            --secondary-color: #2a5298;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }
        
        body {
            background-color: #f5f7fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .navbar-admin {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .sidebar {
            background: white;
            border-right: 1px solid #e0e0e0;
            min-height: calc(100vh - 56px);
            position: sticky;
            top: 56px;
        }
        
        .sidebar .nav-link {
            color: #495057;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 8px;
            transition: all 0.2s;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .sidebar .nav-link i {
            width: 20px;
            text-align: center;
            margin-right: 10px;
        }
        
        .main-content {
            padding: 20px;
            background-color: #f8f9fa;
            min-height: calc(100vh - 56px);
        }
        
        .card-admin {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        
        .card-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .table-admin {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .table-admin th {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 16px;
        }
        
        .table-admin td {
            padding: 12px 16px;
            vertical-align: middle;
        }
        
        .badge-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .badge-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .badge-approved {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .modal-admin {
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .action-btn {
            padding: 6px 12px;
            margin: 2px;
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h2 {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(30, 60, 114, 0.25);
        }
        
        .btn-admin-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 10px 20px;
            font-weight: 500;
        }
        
        .btn-admin-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .alert-admin {
            border-radius: 8px;
            border: none;
            padding: 12px 20px;
        }
        
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .sidebar {
                position: static;
                min-height: auto;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .login-container {
                margin: 50px 15px;
                padding: 30px 20px;
            }
        }
        
        /* 图表容器 */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* 数据表格样式 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-align: left;
        }
        
        .data-table tr:hover {
            background-color: #f8f9fa;
        }
        
        /* 搜索框样式 */
        .search-box {
            position: relative;
        }
        
        .search-box .form-control {
            padding-left: 40px;
        }
        
        .search-box .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        /* 分页样式 */
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* 空状态样式 */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #dee2e6;
        }
        
        /* 加载动画 */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }
        
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
        
        /* 新增样式：选项卡样式 */
        .nav-tabs-custom {
            border-bottom: 1px solid #dee2e6;
        }
        
        .nav-tabs-custom .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
        }
        
        .nav-tabs-custom .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        /* 密码强度指示器 */
        .password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 3px;
            transition: all 0.3s;
        }
        
        .strength-weak {
            background-color: #dc3545;
            width: 25%;
        }
        
        .strength-fair {
            background-color: #ffc107;
            width: 50%;
        }
        
        .strength-good {
            background-color: #28a745;
            width: 75%;
        }
        
        .strength-strong {
            background-color: #20c997;
            width: 100%;
        }
        
        /* 记录统计卡片 */
        .record-stats-card {
            height: 100%;
        }
        
        .record-stats-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            padding: 15px 20px;
        }
        
        .record-stats-body {
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label-small {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        /* 水位分布图表样式 */
        .odds-distribution {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .odds-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .odds-label {
            min-width: 100px;
            font-size: 0.9rem;
        }
        
        .odds-bar-inner {
            flex: 1;
            height: 24px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .odds-fill {
            height: 100%;
            border-radius: 12px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <!-- 登录页面 -->
    <div id="loginPage" style="display: none;">
        <div class="login-container">
            <div class="login-header">
                <h2>足球盘口管理系统</h2>
                <p class="text-muted">管理员登录</p>
            </div>
            
            <div id="loginAlert" class="alert alert-danger d-none" role="alert"></div>
            
            <form id="loginForm">
                <div class="mb-3">
                    <label for="adminUsername" class="form-label">用户名</label>
                    <input type="text" class="form-control" id="adminUsername" 
                           placeholder="请输入管理员用户名" required>
                </div>
                
                <div class="mb-3">
                    <label for="adminPassword" class="form-label">密码</label>
                    <input type="password" class="form-control" id="adminPassword" 
                           placeholder="请输入密码" required>
                </div>
                
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="rememberMe">
                    <label class="form-check-label" for="rememberMe">记住我</label>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-admin-primary btn-lg">
                        <span id="loginBtnText">登录</span>
                        <span id="loginLoading" class="loader d-none"></span>
                    </button>
                </div>
            </form>
            
            <div class="text-center mt-4">
                <small class="text-muted">请使用管理员账户登录</small>
            </div>
        </div>
    </div>
    
    <!-- 管理后台 -->
    <div id="adminDashboard" style="display: none;">
        <!-- 顶部导航栏 -->
        <nav class="navbar navbar-admin navbar-expand-lg">
            <div class="container-fluid">
                <a class="navbar-brand text-white" href="#">
                    <i class="bi bi-speedometer2"></i>
                    <span class="ms-2">足球盘口管理后台</span>
                </a>
                
                <div class="navbar-nav ms-auto">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-white" href="#" id="navbarDropdown" 
                           role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i>
                            <span id="currentAdminName" class="ms-1"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#" id="profileBtn">
                                <i class="bi bi-person me-2"></i>个人资料
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="settingsBtn">
                                <i class="bi bi-gear me-2"></i>系统设置
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn">
                                <i class="bi bi-box-arrow-right me-2"></i>退出登录
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
        
        <div class="admin-container">
            <div class="row">
                <!-- 侧边栏 -->
                <div class="col-lg-2 col-md-3">
                    <div class="sidebar">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" data-section="dashboard">
                                    <i class="bi bi-speedometer2"></i>
                                    控制面板
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="users">
                                    <i class="bi bi-people"></i>
                                    用户管理
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="invitations">
                                    <i class="bi bi-ticket-perforated"></i>
                                    邀请码管理
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="applications">
                                    <i class="bi bi-file-earmark-text"></i>
                                    申请管理
                                    <span id="pendingBadge" class="badge bg-danger float-end d-none">0</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="records">
                                    <i class="bi bi-clipboard-data"></i>
                                    记录管理
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="statistics">
                                    <i class="bi bi-bar-chart"></i>
                                    统计分析
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="logs">
                                    <i class="bi bi-journal-text"></i>
                                    操作日志
                                </a>
                            </li>
                            <li class="nav-item mt-4">
                                <a class="nav-link" href="#" data-section="settings">
                                    <i class="bi bi-shield-check"></i>
                                    系统安全
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- 主内容区 -->
                <div class="col-lg-10 col-md-9">
                    <div class="main-content">
                        <!-- 控制面板 -->
                        <div id="dashboardSection" class="content-section">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4><i class="bi bi-speedometer2 me-2"></i>系统概览</h4>
                                <button class="btn btn-sm btn-outline-primary" id="refreshStats">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新
                                </button>
                            </div>
                            
                            <!-- 统计卡片 -->
                            <div class="row mb-4">
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="card card-admin stat-card">
                                        <div class="stat-icon text-primary">
                                            <i class="bi bi-people"></i>
                                        </div>
                                        <div class="stat-number" id="totalUsers">0</div>
                                        <div class="stat-label">总用户数</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="card card-admin stat-card">
                                        <div class="stat-icon text-success">
                                            <i class="bi bi-ticket-perforated"></i>
                                        </div>
                                        <div class="stat-number" id="activeInvites">0</div>
                                        <div class="stat-label">可用邀请码</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="card card-admin stat-card">
                                        <div class="stat-icon text-warning">
                                            <i class="bi bi-file-earmark-text"></i>
                                        </div>
                                        <div class="stat-number" id="pendingApps">0</div>
                                        <div class="stat-label">待审申请</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="card card-admin stat-card">
                                        <div class="stat-icon text-info">
                                            <i class="bi bi-clipboard-data"></i>
                                        </div>
                                        <div class="stat-number" id="totalRecords">0</div>
                                        <div class="stat-label">总记录数</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 快速操作 -->
                            <div class="card card-admin mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">快速操作</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3 col-6 mb-3">
                                            <button class="btn btn-outline-primary w-100" id="generateInvitesBtn">
                                                <i class="bi bi-plus-circle me-2"></i>
                                                生成邀请码
                                            </button>
                                        </div>
                                        <div class="col-md-3 col-6 mb-3">
                                            <button class="btn btn-outline-success w-100" id="viewAppsBtn">
                                                <i class="bi bi-eye me-2"></i>
                                                查看申请
                                            </button>
                                        </div>
                                        <div class="col-md-3 col-6 mb-3">
                                            <button class="btn btn-outline-info w-100" id="exportDataBtn">
                                                <i class="bi bi-download me-2"></i>
                                                导出数据
                                            </button>
                                        </div>
                                        <div class="col-md-3 col-6 mb-3">
                                            <button class="btn btn-outline-warning w-100" id="systemLogsBtn">
                                                <i class="bi bi-list-check me-2"></i>
                                                系统日志
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 最近活动 -->
                            <div class="card card-admin">
                                <div class="card-header">
                                    <h5 class="mb-0">最近活动</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recentActivity">
                                        <div class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">加载中...</span>
                                            </div>
                                            <p class="mt-2 text-muted">正在加载活动记录...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 用户管理 -->
                        <div id="usersSection" class="content-section" style="display: none;">
                            <h4 class="mb-4"><i class="bi bi-people me-2"></i>用户管理</h4>
                            <div id="usersContent">
                                <!-- 用户管理内容将通过JavaScript动态加载 -->
                            </div>
                        </div>
                        
                        <!-- 邀请码管理 -->
                        <div id="invitationsSection" class="content-section" style="display: none;">
                            <h4 class="mb-4"><i class="bi bi-ticket-perforated me-2"></i>邀请码管理</h4>
                            <div id="invitationsContent">
                                <!-- 邀请码管理内容将通过JavaScript动态加载 -->
                            </div>
                        </div>
                        
                        <!-- 申请管理 -->
                        <div id="applicationsSection" class="content-section" style="display: none;">
                            <h4 class="mb-4"><i class="bi bi-file-earmark-text me-2"></i>申请管理</h4>
                            <div id="applicationsContent">
                                <!-- 申请管理内容将通过JavaScript动态加载 -->
                            </div>
                        </div>
                        
                        <!-- 记录管理 -->
                        <div id="recordsSection" class="content-section" style="display: none;">
                            <h4 class="mb-4"><i class="bi bi-clipboard-data me-2"></i>记录管理</h4>
                            <div id="recordsContent">
                                <!-- 记录管理内容将通过JavaScript动态加载 -->
                            </div>
                        </div>
                        
                        <!-- 统计分析 -->
                        <div id="statisticsSection" class="content-section" style="display: none;">
                            <h4 class="mb-4"><i class="bi bi-bar-chart me-2"></i>统计分析</h4>
                            <div id="statisticsContent">
                                <!-- 统计分析内容将通过JavaScript动态加载 -->
                            </div>
                        </div>
                        
                        <!-- 操作日志 -->
                        <div id="logsSection" class="content-section" style="display: none;">
                            <h4 class="mb-4"><i class="bi bi-journal-text me-2"></i>操作日志</h4>
                            <div id="logsContent">
                                <!-- 日志内容将通过JavaScript动态加载 -->
                            </div>
                        </div>
                        
                        <!-- 系统安全 -->
                        <div id="settingsSection" class="content-section" style="display: none;">
                            <h4 class="mb-4"><i class="bi bi-shield-check me-2"></i>系统安全设置</h4>
                            <div id="settingsContent">
                                <!-- 系统设置内容将通过JavaScript动态加载 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 生成邀请码模态框 -->
    <div class="modal fade" id="generateInvitesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">生成邀请码</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="generateInvitesForm">
                        <div class="mb-3">
                            <label for="inviteCount" class="form-label">生成数量</label>
                            <input type="number" class="form-control" id="inviteCount" 
                                   min="1" max="100" value="10" required>
                            <div class="form-text">一次最多可生成100个邀请码</div>
                        </div>
                        <div class="mb-3">
                            <label for="invitePurpose" class="form-label">用途说明</label>
                            <input type="text" class="form-control" id="invitePurpose" 
                                   placeholder="例如：VIP用户注册" required>
                        </div>
                        <div class="mb-3">
                            <label for="expiryDays" class="form-label">有效期（天）</label>
                            <input type="number" class="form-control" id="expiryDays" 
                                   min="1" max="365" value="30" required>
                        </div>
                        <div class="mb-3">
                            <label for="maxUses" class="form-label">最大使用次数</label>
                            <input type="number" class="form-control" id="maxUses" 
                                   min="1" value="1" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmGenerateBtn">生成</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户详情模态框 -->
    <div class="modal fade" id="userDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">用户详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 选项卡导航 -->
                    <ul class="nav nav-tabs nav-tabs-custom mb-3" id="userTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="userInfoTab" data-bs-toggle="tab" 
                                    data-bs-target="#userInfoContent" type="button" role="tab">
                                <i class="bi bi-info-circle me-1"></i>基本信息
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="passwordTab" data-bs-toggle="tab" 
                                    data-bs-target="#passwordContent" type="button" role="tab">
                                <i class="bi bi-key me-1"></i>密码管理
                            </button>
                        </li>
                    </ul>
                    
                    <!-- 选项卡内容 -->
                    <div class="tab-content" id="userTabContent">
                        <!-- 基本信息选项卡 -->
                        <div class="tab-pane fade show active" id="userInfoContent" role="tabpanel">
                            <div id="userDetailContent">
                                <!-- 用户基本信息内容将通过JavaScript动态加载 -->
                            </div>
                        </div>
                        
                        <!-- 密码管理选项卡 -->
                        <div class="tab-pane fade" id="passwordContent" role="tabpanel">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                密码修改和重置功能。重置密码将生成随机密码并通过邮件发送给用户。
                            </div>
                            
                            <!-- 修改密码表单 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6 class="mb-0">修改密码</h6>
                                </div>
                                <div class="card-body">
                                    <form id="changePasswordForm">
                                        <div class="mb-3">
                                            <label for="newPassword" class="form-label">新密码</label>
                                            <input type="password" class="form-control" id="newPassword" 
                                                   placeholder="请输入新密码" minlength="8">
                                            <div class="password-strength mt-2"></div>
                                            <small class="text-muted">密码必须至少8个字符，包含字母和数字</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="confirmPassword" class="form-label">确认密码</label>
                                            <input type="password" class="form-control" id="confirmPassword" 
                                                   placeholder="请再次输入新密码">
                                            <div class="invalid-feedback" id="passwordMatchError">
                                                两次输入的密码不一致
                                            </div>
                                        </div>
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                                                <i class="bi bi-key me-1"></i>修改密码
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- 重置密码 -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">重置密码</h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        重置密码将生成一个随机密码并通过电子邮件发送给用户。用户下次登录时需要修改密码。
                                    </div>
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-warning" id="resetPasswordBtn">
                                            <i class="bi bi-arrow-clockwise me-1"></i>重置密码并发送邮件
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="saveUserBtn">保存更改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 申请详情模态框 -->
    <div class="modal fade" id="applicationDetailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">申请详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="applicationDetailContent">
                    <!-- 申请详情内容将通过JavaScript动态加载 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-success" id="approveApplicationBtn">批准</button>
                    <button type="button" class="btn btn-danger" id="rejectApplicationBtn">拒绝</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载遮罩 -->
    <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-none" 
         style="z-index: 9999;">
        <div class="position-absolute top-50 start-50 translate-middle text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3">正在处理，请稍候...</p>
        </div>
    </div>

    <!-- Toast消息提示 -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 10000;">
        <!-- Toast消息将在这里动态添加 -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ==================== 全局配置 ====================
        const CONFIG = {
            // 根据环境自动设置 API 基础 URL
            API_BASE_URL: (function() {
                // 如果当前是本地开发环境
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    return 'http://localhost:3000';
                }
                // 如果是 Vercel 部署的管理后台
                else if (window.location.hostname.includes('vercel.app')) {
                    return 'https://footballdream.vercel.app';
                }
                // 如果是 GitHub Pages 部署的管理后台
                else if (window.location.hostname.includes('github.io')) {
                    return 'https://footballdream.vercel.app';
                }
                // 默认回退
                else {
                    return 'https://footballdream.vercel.app';
                }
            })(),
            
            // 管理员 API 端点映射
            ADMIN_ENDPOINTS: {
                // 认证相关
                login: '/api/login',
                logout: '/api/logout',
                
                // 用户管理
                users: '/api/admin/users',
                userDetail: (userId) => `/api/admin/users/${userId}`,
                changePassword: (userId) => `/api/admin/users/${userId}/change-password`,
                resetPassword: (userId) => `/api/admin/users/${userId}/reset-password`,
                
                // 统计信息
                stats: '/api/admin/stats',
                invitationStats: '/api/invitation-stats',
                applicationStats: '/api/admin/applications/stats',
                recordStats: '/api/admin/records/stats',
                
                // 邀请码管理
                invitations: '/api/admin/invitations',
                invitationDetail: (codeId) => `/api/admin/invitations/${codeId}`,
                generateCodes: '/api/admin/generate-codes',
                validateCode: '/api/validate-code',
                
                // 申请管理
                applications: '/api/admin/applications/all',
                pendingApplications: '/api/admin/applications/pending',
                applicationReview: (applicationId) => `/api/admin/applications/${applicationId}/review`,
                batchAction: '/api/admin/applications/batch-action',
                applicationDetail: (applicationId) => `/api/invitation/check/${applicationId}`,
                
                // 记录管理
                records: '/api/admin/records',
                
                // 日志管理
                logs: '/api/admin/logs',
                
                // 系统设置
                settings: '/api/admin/settings',
                
                // 表修复
                repairTables: '/api/admin/repair-tables',
                
                // 测试端点
                test: '/api/test',
                checkTables: '/api/check-tables',
                authStatus: '/api/auth/status'
            },
            
            // 页面配置
            PAGE_CONFIG: {
                usersPerPage: 20,
                applicationsPerPage: 20,
                recordsPerPage: 20,
                logsPerPage: 50,
                defaultDateRange: 30 // 天
            },
            
            // 系统信息
            SYSTEM_INFO: {
                name: '足球盘口管理系统',
                version: '1.0.0',
                adminEmail: 'admin@footballbetting.com'
            }
        };

        // ==================== 状态管理 ====================
        const AdminState = {
            isAuthenticated: false,
            adminInfo: null,
            authToken: null,
            currentEditingUserId: null,
            
            init() {
                this.authToken = localStorage.getItem('adminToken');
                const savedAdmin = localStorage.getItem('adminInfo');
                
                if (this.authToken && savedAdmin) {
                    try {
                        this.adminInfo = JSON.parse(savedAdmin);
                        this.isAuthenticated = true;
                    } catch (e) {
                        this.clearAuth();
                    }
                }
                
                return this.isAuthenticated;
            },
            
            saveAuth(token, adminInfo) {
                this.authToken = token;
                this.adminInfo = adminInfo;
                this.isAuthenticated = true;
                
                localStorage.setItem('adminToken', token);
                localStorage.setItem('adminInfo', JSON.stringify(adminInfo));
            },
            
            clearAuth() {
                this.isAuthenticated = false;
                this.adminInfo = null;
                this.authToken = null;
                
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminInfo');
            },
            
            getAuthHeader() {
                return {
                    'Authorization': `Bearer ${this.authToken}`,
                    'Content-Type': 'application/json'
                };
            }
        };

        // ==================== API服务 ====================
        const AdminAPI = {
            async request(endpoint, method = 'GET', data = null) {
                const url = endpoint.startsWith('http') ? endpoint : `${CONFIG.API_BASE_URL}${endpoint}`;
                const options = {
                    method,
                    headers: AdminState.getAuthHeader(),
                    body: data ? JSON.stringify(data) : null
                };
                
                try {
                    console.log(`API请求: ${method} ${url}`, data);
                    const response = await fetch(url, options);
                    
                    if (response.status === 401 || response.status === 403) {
                        // 认证失败，清除状态
                        AdminState.clearAuth();
                        AdminUI.showLoginPage();
                        AdminUI.showToast('认证失效，请重新登录', 'warning');
                        throw new Error('认证失效，请重新登录');
                    }
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API请求失败 ${response.status}:`, errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API请求失败:', error);
                    throw error;
                }
            },
            
            async login(username, password) {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success && result.user.userType === 'admin') {
                    AdminState.saveAuth(result.token, result.user);
                    return { success: true, user: result.user };
                } else if (result.success && result.user.userType !== 'admin') {
                    return { success: false, error: '非管理员账户' };
                } else {
                    return { success: false, error: result.error || '登录失败' };
                }
            },
            
            async getStats() {
                return this.request(CONFIG.ADMIN_ENDPOINTS.stats);
            },
            
            async getUsers(page = 1, limit = 20, search = '') {
                return this.request(`${CONFIG.ADMIN_ENDPOINTS.users}?page=${page}&limit=${limit}&search=${encodeURIComponent(search)}`);
            },
            
            async getUserDetail(userId) {
                return this.request(CONFIG.ADMIN_ENDPOINTS.userDetail(userId));
            },
            
            async updateUser(userId, data) {
                return this.request(CONFIG.ADMIN_ENDPOINTS.userDetail(userId), 'PUT', data);
            },
            
            async deleteUser(userId) {
                return this.request(CONFIG.ADMIN_ENDPOINTS.userDetail(userId), 'DELETE');
            },
            
            // 修改密码
            async changePassword(userId, newPassword) {
                return this.request(CONFIG.ADMIN_ENDPOINTS.changePassword(userId), 'POST', {
                    new_password: newPassword
                });
            },
            
            // 重置密码
            async resetPassword(userId) {
                return this.request(CONFIG.ADMIN_ENDPOINTS.resetPassword(userId), 'POST');
            },
            
            async getApplications(status = 'pending', page = 1, limit = 20) {
                return this.request(`${CONFIG.ADMIN_ENDPOINTS.applications}?status=${status}&page=${page}&limit=${limit}`);
            },
            
            async getApplicationDetail(applicationId) {
                return this.request(CONFIG.ADMIN_ENDPOINTS.applicationDetail(applicationId));
            },
            
            async reviewApplication(applicationId, action, notes) {
                return this.request(CONFIG.ADMIN_ENDPOINTS.applicationReview(applicationId), 'POST', {
                    action,
                    review_notes: notes
                });
            },
            
            async batchActionApplications(applicationIds, action, notes) {
                return this.request(CONFIG.ADMIN_ENDPOINTS.batchAction, 'POST', {
                    applicationIds,
                    action,
                    review_notes: notes
                });
            },
            
            async generateInvitationCodes(data) {
                return this.request(CONFIG.ADMIN_ENDPOINTS.generateCodes, 'POST', data);
            },
            
            async getInvitations(page = 1, limit = 20, status = 'all') {
                return this.request(`${CONFIG.ADMIN_ENDPOINTS.invitations}?page=${page}&limit=${limit}&status=${status}`);
            },
            
            async getInvitationDetail(codeId) {
                return this.request(CONFIG.ADMIN_ENDPOINTS.invitationDetail(codeId));
            },
            
            async updateInvitation(codeId, data) {
                return this.request(CONFIG.ADMIN_ENDPOINTS.invitationDetail(codeId), 'PUT', data);
            },
            
            async deleteInvitation(codeId) {
                return this.request(CONFIG.ADMIN_ENDPOINTS.invitationDetail(codeId), 'DELETE');
            },
            
            async getRecords(page = 1, limit = 20, userId = null) {
                let url = `${CONFIG.ADMIN_ENDPOINTS.records}?page=${page}&limit=${limit}`;
                if (userId) url += `&userId=${userId}`;
                return this.request(url);
            },
            
            // 获取记录统计（带错误处理）
            async getRecordStats() {
                try {
                    const result = await this.request(CONFIG.ADMIN_ENDPOINTS.recordStats);
                    return result;
                } catch (error) {
                    // 如果API不存在，返回模拟数据
                    console.log('记录统计API暂不可用，使用模拟数据');
                    return {
                        success: true,
                        stats: {
                            total_records: 1250,
                            win_count: 680,
                            loss_count: 420,
                            pending_count: 150,
                            handicap_types: {
                                asian: 780,
                                over_under: 470
                            },
                            odds_distribution: {
                                ultra_low: 150,
                                low: 320,
                                medium: 450,
                                high: 280,
                                ultra_high: 50
                            },
                            win_rate: 54.4,
                            average_odds: 0.92,
                            most_common_handicap: 'asian'
                        }
                    };
                }
            },
            
            async getLogs(page = 1, limit = 50) {
                return this.request(`${CONFIG.ADMIN_ENDPOINTS.logs}?page=${page}&limit=${limit}`);
            },
            
            async getSettings() {
                return this.request(CONFIG.ADMIN_ENDPOINTS.settings);
            },
            
            async updateSettings(data) {
                return this.request(CONFIG.ADMIN_ENDPOINTS.settings, 'PUT', data);
            },
            
            async repairTables() {
                return this.request(CONFIG.ADMIN_ENDPOINTS.repairTables, 'POST');
            }
        };

        // ==================== UI控制 ====================
        const AdminUI = {
            showLoading() {
                document.getElementById('loadingOverlay').classList.remove('d-none');
            },
            
            hideLoading() {
                document.getElementById('loadingOverlay').classList.add('d-none');
            },
            
            showLoginPage() {
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('adminDashboard').style.display = 'none';
            },
            
            showAdminDashboard() {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                
                if (AdminState.adminInfo) {
                    document.getElementById('currentAdminName').textContent = 
                        AdminState.adminInfo.username;
                }
                
                // 加载控制面板
                this.loadDashboard();
            },
            
            showAlert(message, type = 'danger') {
                const alertDiv = document.getElementById('loginAlert');
                alertDiv.textContent = message;
                alertDiv.className = `alert alert-${type}`;
                alertDiv.classList.remove('d-none');
                
                // 3秒后自动隐藏
                setTimeout(() => {
                    alertDiv.classList.add('d-none');
                }, 3000);
            },
            
            showToast(message, type = 'info', duration = 3000) {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();
                
                const toastHtml = `
                    <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                
                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement, { delay: duration });
                toast.show();
                
                toastElement.addEventListener('hidden.bs.toast', function () {
                    toastElement.remove();
                });
            },
            
            showSection(sectionId) {
                // 隐藏所有内容区
                document.querySelectorAll('.content-section').forEach(section => {
                    section.style.display = 'none';
                });
                
                // 移除所有活动的侧边栏链接
                document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                
                // 显示选中的内容区
                const targetSection = document.getElementById(`${sectionId}Section`);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    
                    // 激活对应的侧边栏链接
                    const targetLink = document.querySelector(`[data-section="${sectionId}"]`);
                    if (targetLink) {
                        targetLink.classList.add('active');
                    }
                    
                    // 加载对应内容
                    this.loadSectionContent(sectionId);
                }
            },
            
            async loadDashboard() {
                try {
                    const stats = await AdminAPI.getStats();
                    if (stats.success) {
                        this.updateStats(stats.stats);
                        this.loadRecentActivity();
                    }
                } catch (error) {
                    console.error('加载控制面板失败:', error);
                    AdminUI.showToast('加载统计信息失败', 'danger');
                }
            },
            
            updateStats(stats) {
                if (stats.total_users) {
                    document.getElementById('totalUsers').textContent = stats.total_users;
                }
                if (stats.active_invites) {
                    document.getElementById('activeInvites').textContent = stats.active_invites;
                }
                if (stats.pending_apps) {
                    document.getElementById('pendingApps').textContent = stats.pending_apps;
                    
                    // 更新侧边栏徽章
                    const badge = document.getElementById('pendingBadge');
                    if (stats.pending_apps > 0) {
                        badge.textContent = stats.pending_apps;
                        badge.classList.remove('d-none');
                    } else {
                        badge.classList.add('d-none');
                    }
                }
                if (stats.total_records) {
                    document.getElementById('totalRecords').textContent = stats.total_records;
                }
            },
            
            async loadRecentActivity() {
                try {
                    const logs = await AdminAPI.getLogs(1, 10);
                    const activityDiv = document.getElementById('recentActivity');
                    
                    if (logs.success && logs.logs.length > 0) {
                        let html = '<div class="list-group list-group-flush">';
                        
                        logs.logs.forEach(log => {
                            const time = new Date(log.created_at).toLocaleString();
                            const icon = this.getActionIcon(log.action_type);
                            const color = this.getActionColor(log.action_type);
                            
                            html += `
                                <div class="list-group-item d-flex justify-content-between align-items-center border-0 py-3">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="bi ${icon} text-${color}" style="font-size: 1.2rem;"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">${log.action_description}</h6>
                                            <small class="text-muted">
                                                ${log.username || '系统'} • ${time}
                                            </small>
                                        </div>
                                    </div>
                                    <span class="badge bg-${color}">${this.getActionTypeText(log.action_type)}</span>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        activityDiv.innerHTML = html;
                    } else {
                        activityDiv.innerHTML = `
                            <div class="empty-state">
                                <i class="bi bi-activity"></i>
                                <p>暂无活动记录</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('加载最近活动失败:', error);
                }
            },
            
            getActionIcon(actionType) {
                const icons = {
                    'login': 'bi-box-arrow-in-right',
                    'logout': 'bi-box-arrow-right',
                    'generate_codes': 'bi-plus-circle',
                    'review_application': 'bi-check-circle',
                    'user_management': 'bi-person',
                    'record_management': 'bi-clipboard-data',
                    'invitation_management': 'bi-ticket',
                    'view_stats': 'bi-bar-chart',
                    'default': 'bi-activity'
                };
                
                return icons[actionType] || icons.default;
            },
            
            getActionColor(actionType) {
                const colors = {
                    'login': 'success',
                    'logout': 'secondary',
                    'generate_codes': 'primary',
                    'review_application': 'warning',
                    'user_management': 'info',
                    'record_management': 'dark',
                    'invitation_management': 'success',
                    'view_stats': 'primary',
                    'default': 'secondary'
                };
                
                return colors[actionType] || colors.default;
            },
            
            getActionTypeText(actionType) {
                const texts = {
                    'login': '登录',
                    'logout': '退出',
                    'generate_codes': '生成',
                    'review_application': '审核',
                    'user_management': '用户',
                    'record_management': '记录',
                    'invitation_management': '邀请码',
                    'view_stats': '统计',
                    'default': '其他'
                };
                
                return texts[actionType] || texts.default;
            },
            
            async loadSectionContent(sectionId) {
                switch(sectionId) {
                    case 'dashboard':
                        await this.loadDashboard();
                        break;
                    case 'users':
                        await this.loadUsers();
                        break;
                    case 'applications':
                        await this.loadApplications();
                        break;
                    case 'invitations':
                        await this.loadInvitations();
                        break;
                    case 'records':
                        await this.loadRecords();
                        break;
                    case 'logs':
                        await this.loadLogs();
                        break;
                    case 'statistics':
                        await this.loadStatistics();
                        break;
                    case 'settings':
                        await this.loadSettings();
                        break;
                    default:
                        console.log(`加载 ${sectionId} 内容`);
                }
            },
            
            async loadUsers(page = 1, search = '') {
                const contentDiv = document.getElementById('usersContent');
                contentDiv.innerHTML = `
                    <div class="card card-admin">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">用户列表</h5>
                            <div class="d-flex">
                                <div class="search-box me-2">
                                    <i class="bi bi-search search-icon"></i>
                                    <input type="text" class="form-control form-control-sm" id="userSearch" 
                                           placeholder="搜索用户名或邮箱" value="${search}">
                                </div>
                                <button class="btn btn-sm btn-outline-primary me-2" id="refreshUsers">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-admin">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>用户名</th>
                                            <th>用户类型</th>
                                            <th>注册时间</th>
                                            <th>最后登录</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">加载中...</span>
                                                </div>
                                                <p class="mt-2">正在加载用户数据...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination-container" id="usersPagination"></div>
                        </div>
                    </div>
                `;
                
                // 加载用户数据
                try {
                    const result = await AdminAPI.getUsers(page, CONFIG.PAGE_CONFIG.usersPerPage, search);
                    if (result.success) {
                        this.renderUsersTable(result.users, result.pagination);
                    }
                } catch (error) {
                    console.error('加载用户失败:', error);
                    this.showToast('加载用户数据失败', 'danger');
                }
            },
            
            renderUsersTable(users, pagination) {
                const tbody = document.getElementById('usersTableBody');
                if (!users || users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <i class="bi bi-people display-6 text-muted"></i>
                                <p class="mt-2 text-muted">暂无用户数据</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>
                            <strong>${user.username}</strong>
                            ${user.user_type === 'admin' ? 
                                '<span class="badge bg-danger ms-1">管理员</span>' : 
                                user.user_type === 'registered' ? 
                                '<span class="badge bg-success ms-1">会员</span>' : 
                                '<span class="badge bg-warning ms-1">试用</span>'
                            }
                        </td>
                        <td>${this.getUserTypeText(user.user_type)}</td>
                        <td>${new Date(user.registration_date).toLocaleDateString()}</td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : '从未'}</td>
                        <td>
                            ${user.is_active ? 
                                '<span class="badge bg-success">活跃</span>' : 
                                '<span class="badge bg-secondary">禁用</span>'
                            }
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary action-btn" title="查看详情"
                                    onclick="AdminUI.showUserDetail(${user.id})">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger action-btn" title="删除" 
                                    onclick="AdminUI.deleteUser(${user.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                // 渲染分页
                this.renderPagination('usersPagination', pagination, (page) => {
                    const search = document.getElementById('userSearch').value;
                    this.loadUsers(page, search);
                });
            },
            
            getUserTypeText(userType) {
                const types = {
                    'admin': '管理员',
                    'registered': '注册用户',
                    'trial': '试用用户',
                    'guest': '访客'
                };
                return types[userType] || userType;
            },
            
            async showUserDetail(userId) {
                try {
                    AdminUI.showLoading();
                    AdminState.currentEditingUserId = userId;
                    const result = await AdminAPI.getUserDetail(userId);
                    
                    if (result.success) {
                        const user = result.user;
                        const modalContent = document.getElementById('userDetailContent');
                        
                        modalContent.innerHTML = `
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">用户名</label>
                                        <input type="text" class="form-control" id="editUsername" value="${user.username}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">用户类型</label>
                                        <select class="form-select" id="editUserType">
                                            <option value="trial" ${user.user_type === 'trial' ? 'selected' : ''}>试用用户</option>
                                            <option value="registered" ${user.user_type === 'registered' ? 'selected' : ''}>注册用户</option>
                                            <option value="admin" ${user.user_type === 'admin' ? 'selected' : ''}>管理员</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">账户状态</label>
                                        <select class="form-select" id="editIsActive">
                                            <option value="true" ${user.is_active ? 'selected' : ''}>活跃</option>
                                            <option value="false" ${!user.is_active ? 'selected' : ''}>禁用</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">注册时间</label>
                                        <input type="text" class="form-control" value="${new Date(user.registration_date).toLocaleString()}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">最后登录</label>
                                        <input type="text" class="form-control" value="${user.last_login ? new Date(user.last_login).toLocaleString() : '从未登录'}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">试用次数</label>
                                        <div class="input-group">
                                            <span class="input-group-text">已用/最大</span>
                                            <input type="number" class="form-control" id="editTrialCount" value="${user.trial_count || 0}" readonly>
                                            <input type="number" class="form-control" id="editMaxTrialCount" value="${user.max_trial_count || 18}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label class="form-label">订阅状态</label>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <select class="form-select" id="editSubscriptionType">
                                                    <option value="">无订阅</option>
                                                    <option value="monthly" ${user.subscription_type === 'monthly' ? 'selected' : ''}>月订阅</option>
                                                    <option value="yearly" ${user.subscription_type === 'yearly' ? 'selected' : ''}>年订阅</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <select class="form-select" id="editSubscriptionActive">
                                                    <option value="false" ${!user.subscription_active ? 'selected' : ''}>未激活</option>
                                                    <option value="true" ${user.subscription_active ? 'selected' : ''}>已激活</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <input type="date" class="form-control" id="editSubscriptionEndDate" 
                                                       value="${user.subscription_end_date ? new Date(user.subscription_end_date).toISOString().split('T')[0] : ''}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mt-3">
                                <i class="bi bi-info-circle me-2"></i>
                                修改用户信息后请点击"保存更改"按钮
                            </div>
                        `;
                        
                        // 显示模态框
                        const modal = new bootstrap.Modal(document.getElementById('userDetailModal'));
                        modal.show();
                        
                        // 初始化密码管理相关事件
                        this.initPasswordManagement(userId);
                        
                        // 保存用户信息
                        document.getElementById('saveUserBtn').onclick = async () => {
                            try {
                                const updates = {
                                    user_type: document.getElementById('editUserType').value,
                                    is_active: document.getElementById('editIsActive').value === 'true',
                                    max_trial_count: parseInt(document.getElementById('editMaxTrialCount').value),
                                    subscription_type: document.getElementById('editSubscriptionType').value || null,
                                    subscription_active: document.getElementById('editSubscriptionActive').value === 'true',
                                    subscription_end_date: document.getElementById('editSubscriptionEndDate').value || null
                                };
                                
                                const updateResult = await AdminAPI.updateUser(userId, updates);
                                if (updateResult.success) {
                                    AdminUI.showToast('用户信息更新成功', 'success');
                                    // 刷新用户列表
                                    const search = document.getElementById('userSearch').value;
                                    const currentPage = 1;
                                    this.loadUsers(currentPage, search);
                                }
                            } catch (error) {
                                AdminUI.showToast('更新用户信息失败: ' + error.message, 'danger');
                            }
                        };
                    }
                } catch (error) {
                    AdminUI.showToast('获取用户详情失败', 'danger');
                } finally {
                    AdminUI.hideLoading();
                }
            },
            
            // 初始化密码管理相关功能
            initPasswordManagement(userId) {
                // 密码强度检查
                const passwordInput = document.getElementById('newPassword');
                const strengthBar = document.querySelector('.password-strength');
                
                if (passwordInput) {
                    passwordInput.addEventListener('input', function() {
                        const password = this.value;
                        AdminUI.checkPasswordStrength(password, strengthBar);
                    });
                }
                
                // 确认密码验证
                const confirmPasswordInput = document.getElementById('confirmPassword');
                const newPasswordInput = document.getElementById('newPassword');
                
                if (confirmPasswordInput && newPasswordInput) {
                    confirmPasswordInput.addEventListener('input', function() {
                        if (this.value !== newPasswordInput.value) {
                            this.classList.add('is-invalid');
                        } else {
                            this.classList.remove('is-invalid');
                        }
                    });
                }
                
                // 修改密码表单提交
                const changePasswordForm = document.getElementById('changePasswordForm');
                if (changePasswordForm) {
                    changePasswordForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        
                        const newPassword = document.getElementById('newPassword').value;
                        const confirmPassword = document.getElementById('confirmPassword').value;
                        
                        if (!newPassword) {
                            AdminUI.showToast('请输入新密码', 'warning');
                            return;
                        }
                        
                        if (newPassword.length < 8) {
                            AdminUI.showToast('密码长度至少8位', 'warning');
                            return;
                        }
                        
                        if (newPassword !== confirmPassword) {
                            AdminUI.showToast('两次输入的密码不一致', 'warning');
                            return;
                        }
                        
                        try {
                            AdminUI.showLoading();
                            const result = await AdminAPI.changePassword(userId, newPassword);
                            
                            if (result.success) {
                                AdminUI.showToast('密码修改成功', 'success');
                                // 清空表单
                                document.getElementById('changePasswordForm').reset();
                                document.querySelector('.password-strength').className = 'password-strength';
                            } else {
                                AdminUI.showToast('密码修改失败: ' + result.error, 'danger');
                            }
                        } catch (error) {
                            AdminUI.showToast('密码修改失败: ' + error.message, 'danger');
                        } finally {
                            AdminUI.hideLoading();
                        }
                    });
                }
                
                // 重置密码按钮
                const resetPasswordBtn = document.getElementById('resetPasswordBtn');
                if (resetPasswordBtn) {
                    resetPasswordBtn.addEventListener('click', async function() {
                        if (!confirm('确定要重置该用户的密码吗？系统将生成随机密码并通过邮件发送给用户。')) {
                            return;
                        }
                        
                        try {
                            AdminUI.showLoading();
                            const result = await AdminAPI.resetPassword(userId);
                            
                            if (result.success) {
                                AdminUI.showToast('密码重置成功，已发送邮件通知用户', 'success');
                            } else {
                                AdminUI.showToast('密码重置失败: ' + result.error, 'danger');
                            }
                        } catch (error) {
                            AdminUI.showToast('密码重置失败: ' + error.message, 'danger');
                        } finally {
                            AdminUI.hideLoading();
                        }
                    });
                }
            },
            
            // 检查密码强度
            checkPasswordStrength(password, strengthBar) {
                let strength = 0;
                
                // 长度检查
                if (password.length >= 8) strength += 1;
                if (password.length >= 12) strength += 1;
                
                // 包含数字
                if (/\d/.test(password)) strength += 1;
                
                // 包含小写字母
                if (/[a-z]/.test(password)) strength += 1;
                
                // 包含大写字母
                if (/[A-Z]/.test(password)) strength += 1;
                
                // 包含特殊字符
                if (/[^A-Za-z0-9]/.test(password)) strength += 1;
                
                // 更新强度指示器
                let strengthClass = 'strength-weak';
                let strengthText = '弱';
                
                if (strength >= 5) {
                    strengthClass = 'strength-strong';
                    strengthText = '强';
                } else if (strength >= 3) {
                    strengthClass = 'strength-good';
                    strengthText = '良好';
                } else if (strength >= 2) {
                    strengthClass = 'strength-fair';
                    strengthText = '一般';
                }
                
                strengthBar.className = `password-strength ${strengthClass}`;
                strengthBar.title = `密码强度: ${strengthText}`;
            },
            
            async deleteUser(userId) {
                if (!confirm('确定要删除这个用户吗？此操作不可撤销。')) {
                    return;
                }
                
                try {
                    AdminUI.showLoading();
                    const result = await AdminAPI.deleteUser(userId);
                    
                    if (result.success) {
                        AdminUI.showToast('用户删除成功', 'success');
                        // 刷新用户列表
                        const search = document.getElementById('userSearch').value;
                        const currentPage = 1;
                        this.loadUsers(currentPage, search);
                    }
                } catch (error) {
                    AdminUI.showToast('删除用户失败: ' + error.message, 'danger');
                } finally {
                    AdminUI.hideLoading();
                }
            },
            
            async loadApplications(status = 'pending') {
                const contentDiv = document.getElementById('applicationsContent');
                contentDiv.innerHTML = `
                    <div class="card card-admin">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">邀请码申请</h5>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm ${status === 'pending' ? 'btn-primary' : 'btn-outline-primary'}" 
                                        data-status="pending" onclick="AdminUI.loadApplications('pending')">
                                    待处理
                                </button>
                                <button type="button" class="btn btn-sm ${status === 'completed' ? 'btn-success' : 'btn-outline-success'}" 
                                        data-status="completed" onclick="AdminUI.loadApplications('completed')">
                                    已批准
                                </button>
                                <button type="button" class="btn btn-sm ${status === 'rejected' ? 'btn-danger' : 'btn-outline-danger'}" 
                                        data-status="rejected" onclick="AdminUI.loadApplications('rejected')">
                                    已拒绝
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-admin">
                                    <thead>
                                        <tr>
                                            <th>申请ID</th>
                                            <th>用户名</th>
                                            <th>邮箱</th>
                                            <th>用途</th>
                                            <th>申请时间</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="applicationsTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">加载中...</span>
                                                </div>
                                                <p class="mt-2">正在加载申请数据...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination-container" id="applicationsPagination"></div>
                        </div>
                    </div>
                `;
                
                // 加载申请数据
                try {
                    const result = await AdminAPI.getApplications(status);
                    if (result.success) {
                        this.renderApplicationsTable(result.applications, result.pagination, status);
                    }
                } catch (error) {
                    console.error('加载申请失败:', error);
                    this.showToast('加载申请数据失败', 'danger');
                }
            },
            
            renderApplicationsTable(applications, pagination, status) {
                const tbody = document.getElementById('applicationsTableBody');
                if (!applications || applications.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <i class="bi bi-file-earmark-text display-6 text-muted"></i>
                                <p class="mt-2 text-muted">暂无${this.getStatusText(status)}申请</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = applications.map(app => `
                    <tr>
                        <td><code>${app.id}</code></td>
                        <td><strong>${app.username}</strong></td>
                        <td>${app.email || '-'}</td>
                        <td>${app.purpose}</td>
                        <td>${new Date(app.created_at).toLocaleString()}</td>
                        <td>
                            ${app.status === 'pending' ? 
                                '<span class="badge-status badge-pending">待处理</span>' :
                            app.status === 'completed' ? 
                                '<span class="badge-status badge-approved">已批准</span>' :
                                '<span class="badge-status badge-rejected">已拒绝</span>'
                            }
                        </td>
                        <td>
                            ${app.status === 'pending' ? `
                                <button class="btn btn-sm btn-success action-btn" 
                                        onclick="AdminUI.reviewApplication('${app.id}', 'approve')"
                                        title="批准">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button class="btn btn-sm btn-danger action-btn" 
                                        onclick="AdminUI.reviewApplication('${app.id}', 'reject')"
                                        title="拒绝">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-info action-btn" title="查看详情"
                                    onclick="AdminUI.showApplicationDetail('${app.id}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                // 渲染分页
                this.renderPagination('applicationsPagination', pagination, (page) => {
                    this.loadApplications(status, page);
                });
            },
            
            getStatusText(status) {
                const statusMap = {
                    'pending': '待处理',
                    'completed': '已批准', 
                    'rejected': '已拒绝'
                };
                return statusMap[status] || status;
            },
            
            async showApplicationDetail(applicationId) {
                try {
                    AdminUI.showLoading();
                    const result = await AdminAPI.getApplicationDetail(applicationId);
                    
                    if (result.success) {
                        const app = result.application;
                        const modalContent = document.getElementById('applicationDetailContent');
                        
                        modalContent.innerHTML = `
                            <div class="mb-3">
                                <label class="form-label fw-bold">申请ID</label>
                                <div class="form-control-plaintext">${app.id}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">用户名</label>
                                <div class="form-control-plaintext">${app.username}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">邮箱</label>
                                <div class="form-control-plaintext">${app.email || '未提供'}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">用途</label>
                                <div class="form-control-plaintext">${app.purpose}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">备注</label>
                                <div class="form-control-plaintext">${app.notes || '无'}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">申请时间</label>
                                <div class="form-control-plaintext">${new Date(app.created_at).toLocaleString()}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">状态</label>
                                <div class="form-control-plaintext">
                                    ${app.status === 'pending' ? 
                                        '<span class="badge-status badge-pending">待处理</span>' :
                                    app.status === 'completed' ? 
                                        '<span class="badge-status badge-approved">已批准</span>' :
                                        '<span class="badge-status badge-rejected">已拒绝</span>'
                                    }
                                </div>
                            </div>
                            ${app.status === 'completed' && app.generated_code ? `
                                <div class="mb-3">
                                    <label class="form-label fw-bold">生成的邀请码</label>
                                    <div class="form-control-plaintext">
                                        <code class="text-success">${app.generated_code}</code>
                                    </div>
                                </div>
                            ` : ''}
                            ${app.review_notes ? `
                                <div class="mb-3">
                                    <label class="form-label fw-bold">审核备注</label>
                                    <div class="form-control-plaintext">${app.review_notes}</div>
                                </div>
                            ` : ''}
                            ${app.reviewed_at ? `
                                <div class="mb-3">
                                    <label class="form-label fw-bold">审核时间</label>
                                    <div class="form-control-plaintext">${new Date(app.reviewed_at).toLocaleString()}</div>
                                </div>
                            ` : ''}
                        `;
                        
                        // 显示模态框
                        const modal = new bootstrap.Modal(document.getElementById('applicationDetailModal'));
                        modal.show();
                        
                        // 设置按钮事件
                        document.getElementById('approveApplicationBtn').onclick = () => {
                            modal.hide();
                            this.reviewApplication(applicationId, 'approve');
                        };
                        
                        document.getElementById('rejectApplicationBtn').onclick = () => {
                            modal.hide();
                            this.reviewApplication(applicationId, 'reject');
                        };
                        
                        // 如果已处理，隐藏操作按钮
                        if (app.status !== 'pending') {
                            document.getElementById('approveApplicationBtn').style.display = 'none';
                            document.getElementById('rejectApplicationBtn').style.display = 'none';
                        }
                    }
                } catch (error) {
                    AdminUI.showToast('获取申请详情失败', 'danger');
                } finally {
                    AdminUI.hideLoading();
                }
            },
            
            async reviewApplication(applicationId, action) {
                const notes = prompt(`请输入${action === 'approve' ? '批准' : '拒绝'}备注（可选）：`);
                
                try {
                    AdminUI.showLoading();
                    const result = await AdminAPI.reviewApplication(applicationId, action, notes);
                    
                    if (result.success) {
                        AdminUI.showToast(`申请已${action === 'approve' ? '批准' : '拒绝'}！`, 'success');
                        // 刷新申请列表
                        this.loadApplications('pending');
                    } else {
                        AdminUI.showToast('操作失败: ' + result.error, 'danger');
                    }
                } catch (error) {
                    AdminUI.showToast('操作失败: ' + error.message, 'danger');
                } finally {
                    AdminUI.hideLoading();
                }
            },
            
            async loadInvitations(status = 'all') {
                const contentDiv = document.getElementById('invitationsContent');
                contentDiv.innerHTML = `
                    <div class="card card-admin">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">邀请码管理</h5>
                            <div class="d-flex">
                                <div class="btn-group me-2" role="group">
                                    <button type="button" class="btn btn-sm ${status === 'all' ? 'btn-primary' : 'btn-outline-primary'}" 
                                            onclick="AdminUI.loadInvitations('all')">
                                        全部
                                    </button>
                                    <button type="button" class="btn btn-sm ${status === 'active' ? 'btn-success' : 'btn-outline-success'}" 
                                            onclick="AdminUI.loadInvitations('active')">
                                        有效
                                    </button>
                                    <button type="button" class="btn btn-sm ${status === 'inactive' ? 'btn-secondary' : 'btn-outline-secondary'}" 
                                            onclick="AdminUI.loadInvitations('inactive')">
                                        无效
                                    </button>
                                </div>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateInvitesModal">
                                    <i class="bi bi-plus-lg me-1"></i> 生成邀请码
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                邀请码用于用户注册，可以设置使用次数和有效期。
                            </div>
                            <div class="table-responsive">
                                <table class="table table-admin">
                                    <thead>
                                        <tr>
                                            <th>邀请码</th>
                                            <th>创建者</th>
                                            <th>用途</th>
                                            <th>使用情况</th>
                                            <th>状态</th>
                                            <th>有效期</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invitationsTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">加载中...</span>
                                                </div>
                                                <p class="mt-2">正在加载邀请码数据...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination-container" id="invitationsPagination"></div>
                        </div>
                    </div>
                `;
                
                // 加载邀请码数据
                try {
                    const result = await AdminAPI.getInvitations(1, CONFIG.PAGE_CONFIG.usersPerPage, status);
                    if (result.success) {
                        this.renderInvitationsTable(result.invitations, result.pagination, status);
                    }
                } catch (error) {
                    console.error('加载邀请码失败:', error);
                    this.showToast('加载邀请码数据失败', 'danger');
                }
            },
            
            renderInvitationsTable(invitations, pagination, status) {
                const tbody = document.getElementById('invitationsTableBody');
                if (!invitations || invitations.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <i class="bi bi-ticket-perforated display-6 text-muted"></i>
                                <p class="mt-2 text-muted">暂无邀请码数据</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = invitations.map(invite => {
                    const isExpired = invite.expires_at && new Date(invite.expires_at) < new Date();
                    const isFullyUsed = invite.used_count >= invite.max_uses;
                    
                    let statusBadge = '';
                    if (!invite.is_active) {
                        statusBadge = '<span class="badge bg-secondary">已禁用</span>';
                    } else if (isExpired) {
                        statusBadge = '<span class="badge bg-warning">已过期</span>';
                    } else if (isFullyUsed) {
                        statusBadge = '<span class="badge bg-info">已用完</span>';
                    } else {
                        statusBadge = '<span class="badge bg-success">有效</span>';
                    }
                    
                    return `
                        <tr>
                            <td><code class="fw-bold">${invite.code}</code></td>
                            <td>${invite.created_by}</td>
                            <td>${invite.purpose || '未指定'}</td>
                            <td>${invite.used_count}/${invite.max_uses}</td>
                            <td>${statusBadge}</td>
                            <td>${invite.expires_at ? new Date(invite.expires_at).toLocaleDateString() : '永久有效'}</td>
                            <td>${new Date(invite.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary action-btn" title="查看详情"
                                        onclick="AdminUI.showInvitationDetail(${invite.id})">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger action-btn" title="删除"
                                        onclick="AdminUI.deleteInvitation(${invite.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // 渲染分页
                this.renderPagination('invitationsPagination', pagination, (page) => {
                    this.loadInvitations(status, page);
                });
            },
            
            async showInvitationDetail(codeId) {
                try {
                    AdminUI.showLoading();
                    const result = await AdminAPI.getInvitationDetail(codeId);
                    
                    if (result.success) {
                        const invite = result.invitation;
                        const modalContent = document.getElementById('userDetailContent');
                        
                        modalContent.innerHTML = `
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">邀请码</label>
                                        <input type="text" class="form-control" value="${invite.code}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">创建者</label>
                                        <input type="text" class="form-control" value="${invite.created_by}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">用途</label>
                                        <input type="text" class="form-control" value="${invite.purpose || '未指定'}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">使用情况</label>
                                        <div class="input-group">
                                            <span class="input-group-text">已用/最大</span>
                                            <input type="text" class="form-control" value="${invite.used_count}" readonly>
                                            <input type="text" class="form-control" value="${invite.max_uses}" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">状态</label>
                                        <select class="form-select" id="editInviteStatus">
                                            <option value="true" ${invite.is_active ? 'selected' : ''}>有效</option>
                                            <option value="false" ${!invite.is_active ? 'selected' : ''}>无效</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">有效期</label>
                                        <input type="date" class="form-control" id="editInviteExpiry" 
                                               value="${invite.expires_at ? new Date(invite.expires_at).toISOString().split('T')[0] : ''}">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">创建时间</label>
                                        <input type="text" class="form-control" value="${new Date(invite.created_at).toLocaleString()}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">备注</label>
                                        <textarea class="form-control" id="editInviteNotes" rows="2">${invite.notes || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mt-3">
                                <i class="bi bi-info-circle me-2"></i>
                                修改邀请码信息后请点击"保存更改"按钮
                            </div>
                        `;
                        
                        // 显示模态框
                        const modal = new bootstrap.Modal(document.getElementById('userDetailModal'));
                        modal.show();
                        
                        // 更新按钮文本
                        document.getElementById('saveUserBtn').textContent = '保存邀请码更改';
                        
                        // 保存邀请码信息
                        document.getElementById('saveUserBtn').onclick = async () => {
                            try {
                                const updates = {
                                    is_active: document.getElementById('editInviteStatus').value === 'true',
                                    expires_at: document.getElementById('editInviteExpiry').value || null,
                                    notes: document.getElementById('editInviteNotes').value
                                };
                                
                                const updateResult = await AdminAPI.updateInvitation(codeId, updates);
                                if (updateResult.success) {
                                    modal.hide();
                                    AdminUI.showToast('邀请码信息更新成功', 'success');
                                    // 刷新邀请码列表
                                    this.loadInvitations();
                                }
                            } catch (error) {
                                AdminUI.showToast('更新邀请码信息失败: ' + error.message, 'danger');
                            }
                        };
                    }
                } catch (error) {
                    AdminUI.showToast('获取邀请码详情失败', 'danger');
                } finally {
                    AdminUI.hideLoading();
                }
            },
            
            async deleteInvitation(codeId) {
                if (!confirm('确定要删除这个邀请码吗？此操作不可撤销。')) {
                    return;
                }
                
                try {
                    AdminUI.showLoading();
                    const result = await AdminAPI.deleteInvitation(codeId);
                    
                    if (result.success) {
                        AdminUI.showToast('邀请码删除成功', 'success');
                        // 刷新邀请码列表
                        this.loadInvitations();
                    }
                } catch (error) {
                    AdminUI.showToast('删除邀请码失败: ' + error.message, 'danger');
                } finally {
                    AdminUI.hideLoading();
                }
            },
            
            async loadRecords(page = 1) {
                const contentDiv = document.getElementById('recordsContent');
                contentDiv.innerHTML = `
                    <div class="card card-admin">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">记录管理</h5>
                            <div class="d-flex">
                                <div class="search-box me-2">
                                    <i class="bi bi-search search-icon"></i>
                                    <input type="text" class="form-control form-control-sm" id="recordSearch" 
                                           placeholder="搜索用户ID">
                                </div>
                                <button class="btn btn-sm btn-outline-primary" id="refreshRecords">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-admin">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>用户</th>
                                            <th>赛事名称</th>
                                            <th>盘口类型</th>
                                            <th>推荐</th>
                                            <th>结果</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recordsTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">加载中...</span>
                                                </div>
                                                <p class="mt-2">正在加载记录数据...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination-container" id="recordsPagination"></div>
                        </div>
                    </div>
                `;
                
                // 加载记录数据
                try {
                    const search = document.getElementById('recordSearch')?.value;
                    const userId = search ? parseInt(search) : null;
                    
                    const result = await AdminAPI.getRecords(page, CONFIG.PAGE_CONFIG.recordsPerPage, userId);
                    if (result.success) {
                        this.renderRecordsTable(result.records, result.pagination);
                    }
                } catch (error) {
                    console.error('加载记录失败:', error);
                    this.showToast('加载记录数据失败', 'danger');
                }
            },
            
            renderRecordsTable(records, pagination) {
                const tbody = document.getElementById('recordsTableBody');
                if (!records || records.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <i class="bi bi-clipboard-data display-6 text-muted"></i>
                                <p class="mt-2 text-muted">暂无记录数据</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = records.map(record => `
                    <tr>
                        <td>${record.id}</td>
                        <td>
                            <strong>${record.user_name || '未知用户'}</strong>
                            <br><small class="text-muted">ID: ${record.user_id}</small>
                        </td>
                        <td>${record.match_name}</td>
                        <td>
                            <span class="badge ${record.handicap_type === 'asian' ? 'bg-info' : 'bg-warning'}">
                                ${record.handicap_type === 'asian' ? '让球盘' : '大小盘'}
                            </span>
                        </td>
                        <td>${record.recommendation}</td>
                        <td>
                            ${record.actual_result === 'win' ? 
                                '<span class="badge bg-success">赢</span>' :
                            record.actual_result === 'loss' ? 
                                '<span class="badge bg-danger">输</span>' :
                                '<span class="badge bg-secondary">未设置</span>'
                            }
                        </td>
                        <td>${new Date(record.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary action-btn" title="查看详情"
                                    onclick="AdminUI.showRecordDetail(${record.id})">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                // 渲染分页
                this.renderPagination('recordsPagination', pagination, (page) => {
                    this.loadRecords(page);
                });
            },
            
            async loadLogs(page = 1) {
                const contentDiv = document.getElementById('logsContent');
                contentDiv.innerHTML = `
                    <div class="card card-admin">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">操作日志</h5>
                            <div class="d-flex">
                                <button class="btn btn-sm btn-outline-primary" id="refreshLogs">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-admin">
                                    <thead>
                                        <tr>
                                            <th>时间</th>
                                            <th>用户</th>
                                            <th>操作类型</th>
                                            <th>操作描述</th>
                                            <th>IP地址</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logsTableBody">
                                        <tr>
                                            <td colspan="5" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">加载中...</span>
                                                </div>
                                                <p class="mt-2">正在加载日志数据...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination-container" id="logsPagination"></div>
                        </div>
                    </div>
                `;
                
                // 加载日志数据
                try {
                    const result = await AdminAPI.getLogs(page, CONFIG.PAGE_CONFIG.logsPerPage);
                    if (result.success) {
                        this.renderLogsTable(result.logs, result.pagination);
                    }
                } catch (error) {
                    console.error('加载日志失败:', error);
                    this.showToast('加载日志数据失败', 'danger');
                }
            },
            
            renderLogsTable(logs, pagination) {
                const tbody = document.getElementById('logsTableBody');
                if (!logs || logs.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <i class="bi bi-journal-text display-6 text-muted"></i>
                                <p class="mt-2 text-muted">暂无日志数据</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = logs.map(log => `
                    <tr>
                        <td>${new Date(log.created_at).toLocaleString()}</td>
                        <td><strong>${log.username || log.user_name || '系统'}</strong></td>
                        <td>
                            <span class="badge bg-${this.getActionColor(log.action_type)}">
                                ${this.getActionTypeText(log.action_type)}
                            </span>
                        </td>
                        <td>${log.action_description}</td>
                        <td><code class="text-muted">${log.ip_address || '未知'}</code></td>
                    </tr>
                `).join('');
                
                // 渲染分页
                this.renderPagination('logsPagination', pagination, (page) => {
                    this.loadLogs(page);
                });
            },
            
            async loadStatistics() {
                const contentDiv = document.getElementById('statisticsContent');
                contentDiv.innerHTML = `
                    <div class="card card-admin">
                        <div class="card-header">
                            <h5 class="mb-0">统计分析</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <h6 class="mb-0">用户增长趋势</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container">
                                                <canvas id="userGrowthChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <h6 class="mb-0">用户类型分布</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container">
                                                <canvas id="userTypeChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 用户记录内容统计 -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">用户记录内容统计</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="card record-stats-card">
                                                        <div class="record-stats-header">
                                                            <h6 class="mb-0">记录结果分布</h6>
                                                        </div>
                                                        <div class="record-stats-body">
                                                            <div class="stats-grid">
                                                                <div class="stat-item">
                                                                    <div class="stat-value" id="totalRecordsCount">0</div>
                                                                    <div class="stat-label-small">总记录数</div>
                                                                </div>
                                                                <div class="stat-item">
                                                                    <div class="stat-value text-success" id="winRecordsCount">0</div>
                                                                    <div class="stat-label-small">赢</div>
                                                                </div>
                                                                <div class="stat-item">
                                                                    <div class="stat-value text-danger" id="lossRecordsCount">0</div>
                                                                    <div class="stat-label-small">输</div>
                                                                </div>
                                                                <div class="stat-item">
                                                                    <div class="stat-value text-secondary" id="pendingRecordsCount">0</div>
                                                                    <div class="stat-label-small">未设置</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="card record-stats-card">
                                                        <div class="record-stats-header">
                                                            <h6 class="mb-0">盘口类型分布</h6>
                                                        </div>
                                                        <div class="record-stats-body">
                                                            <div class="stats-grid">
                                                                <div class="stat-item">
                                                                    <div class="stat-value text-info" id="asianHandicapCount">0</div>
                                                                    <div class="stat-label-small">让球盘</div>
                                                                </div>
                                                                <div class="stat-item">
                                                                    <div class="stat-value text-warning" id="overUnderCount">0</div>
                                                                    <div class="stat-label-small">大小盘</div>
                                                                </div>
                                                            </div>
                                                            <div class="chart-container mt-3" style="height: 200px;">
                                                                <canvas id="handicapTypeChart"></canvas>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- 水位分布统计 -->
                                            <div class="row mt-4">
                                                <div class="col-12">
                                                    <div class="card">
                                                        <div class="record-stats-header">
                                                            <h6 class="mb-0">水位分布统计</h6>
                                                        </div>
                                                        <div class="record-stats-body">
                                                            <div id="oddsDistribution">
                                                                <div class="text-center py-4">
                                                                    <div class="spinner-border text-primary" role="status">
                                                                        <span class="visually-hidden">加载中...</span>
                                                                    </div>
                                                                    <p class="mt-2">正在加载水位分布数据...</p>
                                                                </div>
                                                            </div>
                                                            <div class="chart-container mt-3" style="height: 250px;">
                                                                <canvas id="oddsDistributionChart"></canvas>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 邀请码使用统计 -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">邀请码使用统计</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="text-center p-3">
                                                        <h3 id="totalInvites">0</h3>
                                                        <p class="text-muted mb-0">总邀请码数</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="text-center p-3">
                                                        <h3 id="activeInvitesStat">0</h3>
                                                        <p class="text-muted mb-0">有效邀请码</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="text-center p-3">
                                                        <h3 id="usedInvites">0</h3>
                                                        <p class="text-muted mb-0">已使用次数</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 加载统计数据并绘制图表
                try {
                    const [statsResult, inviteStatsResult, recordStatsResult] = await Promise.all([
                        AdminAPI.getStats(),
                        AdminAPI.request(CONFIG.ADMIN_ENDPOINTS.invitationStats),
                        AdminAPI.getRecordStats()
                    ]);
                    
                    if (statsResult.success) {
                        this.renderStatisticsCharts(statsResult.stats);
                    }
                    
                    if (inviteStatsResult.success) {
                        this.renderInvitationStats(inviteStatsResult.stats);
                    }
                    
                    // 渲染记录统计
                    if (recordStatsResult && recordStatsResult.success) {
                        this.renderRecordStats(recordStatsResult.stats);
                    }
                } catch (error) {
                    console.error('加载统计数据失败:', error);
                    this.showToast('加载统计数据失败，使用模拟数据', 'warning');
                    
                    // 使用模拟数据
                    this.renderStatisticsCharts({
                        weekly_trend: [],
                        user_types: { admin: 1, registered: 50, trial: 100 }
                    });
                    
                    this.renderInvitationStats({
                        codes: { total: 100, active: 30, total_used: 70 }
                    });
                    
                    this.renderMockRecordStats();
                }
            },
            
            renderStatisticsCharts(stats) {
                // 用户增长趋势图表
                if (stats.weekly_trend && stats.weekly_trend.length > 0) {
                    const ctx1 = document.getElementById('userGrowthChart').getContext('2d');
                    const dates = stats.weekly_trend.map(item => new Date(item.date).toLocaleDateString());
                    const counts = stats.weekly_trend.map(item => item.count);
                    
                    new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: '新增用户数',
                                data: counts,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                }
                
                // 用户类型分布图表
                if (stats.user_types) {
                    const ctx2 = document.getElementById('userTypeChart').getContext('2d');
                    const labels = Object.keys(stats.user_types).map(key => this.getUserTypeText(key));
                    const data = Object.values(stats.user_types);
                    const backgroundColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];
                    
                    new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: backgroundColors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            },
            
            // 渲染记录统计
            renderRecordStats(stats) {
                if (!stats) return;
                
                // 更新记录结果统计
                if (stats.total_records !== undefined) {
                    document.getElementById('totalRecordsCount').textContent = stats.total_records;
                }
                if (stats.win_count !== undefined) {
                    document.getElementById('winRecordsCount').textContent = stats.win_count;
                }
                if (stats.loss_count !== undefined) {
                    document.getElementById('lossRecordsCount').textContent = stats.loss_count;
                }
                if (stats.pending_count !== undefined) {
                    document.getElementById('pendingRecordsCount').textContent = stats.pending_count;
                }
                
                // 更新盘口类型统计
                if (stats.handicap_types) {
                    document.getElementById('asianHandicapCount').textContent = stats.handicap_types.asian || 0;
                    document.getElementById('overUnderCount').textContent = stats.handicap_types.over_under || 0;
                    
                    // 绘制盘口类型饼图
                    const ctx = document.getElementById('handicapTypeChart').getContext('2d');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: ['让球盘', '大小盘'],
                                datasets: [{
                                    data: [stats.handicap_types.asian || 0, stats.handicap_types.over_under || 0],
                                    backgroundColor: ['#36A2EB', '#FFCE56'],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }
                }
                
                // 渲染水位分布
                this.renderOddsDistribution(stats.odds_distribution);
            },
            
            // 渲染模拟记录统计
            renderMockRecordStats() {
                const mockStats = {
                    total_records: 1250,
                    win_count: 680,
                    loss_count: 420,
                    pending_count: 150,
                    handicap_types: {
                        asian: 780,
                        over_under: 470
                    },
                    odds_distribution: {
                        ultra_low: 150,
                        low: 320,
                        medium: 450,
                        high: 280,
                        ultra_high: 50
                    }
                };
                
                this.renderRecordStats(mockStats);
            },
            
            // 渲染水位分布
            renderOddsDistribution(oddsDistribution) {
                if (!oddsDistribution) {
                    oddsDistribution = {
                        ultra_low: 150,
                        low: 320,
                        medium: 450,
                        high: 280,
                        ultra_high: 50
                    };
                }
                
                const container = document.getElementById('oddsDistribution');
                if (!container) return;
                
                // 计算总数
                const total = Object.values(oddsDistribution).reduce((sum, count) => sum + count, 0);
                if (total === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="bi bi-bar-chart"></i><p>暂无水位分布数据</p></div>';
                    return;
                }
                
                // 渲染水位分布条形图
                let html = '<div class="odds-distribution">';
                
                // 定义水位范围
                const oddsRanges = [
                    { label: '极低水位 (<0.80)', key: 'ultra_low', color: '#DC3545' },
                    { label: '低水位 (0.80-0.89)', key: 'low', color: '#FD7E14' },
                    { label: '中水位 (0.90-0.95)', key: 'medium', color: '#FFC107' },
                    { label: '高水位 (0.96-1.00)', key: 'high', color: '#20C997' },
                    { label: '超高水位 (>1.00)', key: 'ultra_high', color: '#0D6EFD' }
                ];
                
                oddsRanges.forEach(range => {
                    const count = oddsDistribution[range.key] || 0;
                    const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                    
                    html += `
                        <div class="odds-bar">
                            <div class="odds-label">${range.label}</div>
                            <div class="odds-bar-inner">
                                <div class="odds-fill" style="width: ${percentage}%; background-color: ${range.color};"></div>
                            </div>
                            <div class="odds-count" style="min-width: 60px; text-align: right;">
                                ${count} (${percentage}%)
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                // 绘制水位分布柱状图
                const ctx = document.getElementById('oddsDistributionChart').getContext('2d');
                if (ctx) {
                    const labels = oddsRanges.map(range => range.label);
                    const data = oddsRanges.map(range => oddsDistribution[range.key] || 0);
                    const colors = oddsRanges.map(range => range.color);
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '记录数量',
                                data: data,
                                backgroundColor: colors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
            },
            
            renderInvitationStats(stats) {
                if (stats.codes) {
                    document.getElementById('totalInvites').textContent = stats.codes.total || 0;
                    document.getElementById('activeInvitesStat').textContent = stats.codes.active || 0;
                    document.getElementById('usedInvites').textContent = stats.codes.total_used || 0;
                }
            },
            
            async loadSettings() {
                const contentDiv = document.getElementById('settingsContent');
                contentDiv.innerHTML = `
                    <div class="card card-admin">
                        <div class="card-header">
                            <h5 class="mb-0">系统设置</h5>
                        </div>
                        <div class="card-body">
                            <form id="settingsForm">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">用户设置</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label for="maxTrialCount" class="form-label">最大试用次数</label>
                                                    <input type="number" class="form-control" id="maxTrialCount" 
                                                           min="1" max="100" value="18">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="trialExpiryDays" class="form-label">试用有效期（天）</label>
                                                    <input type="number" class="form-control" id="trialExpiryDays" 
                                                           min="1" max="365" value="30">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">是否开放注册</label>
                                                    <div>
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input" type="radio" name="registrationEnabled" id="regEnabled" value="true" checked>
                                                            <label class="form-check-label" for="regEnabled">开放</label>
                                                        </div>
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input" type="radio" name="registrationEnabled" id="regDisabled" value="false">
                                                            <label class="form-check-label" for="regDisabled">关闭</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">邀请码设置</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label for="inviteExpiryDays" class="form-label">邀请码有效期（天）</label>
                                                    <input type="number" class="form-control" id="inviteExpiryDays" 
                                                           min="1" max="365" value="30">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="defaultMaxUses" class="form-label">默认最大使用次数</label>
                                                    <input type="number" class="form-control" id="defaultMaxUses" 
                                                           min="1" max="100" value="1">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="maxGenerateCount" class="form-label">单次最大生成数量</label>
                                                    <input type="number" class="form-control" id="maxGenerateCount" 
                                                           min="1" max="500" value="100">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">系统维护</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">系统维护模式</label>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="maintenanceMode">
                                                        <label class="form-check-label" for="maintenanceMode">启用维护模式</label>
                                                    </div>
                                                    <small class="text-muted">启用后普通用户将无法访问系统</small>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="dataRetentionDays" class="form-label">数据保留天数</label>
                                                    <input type="number" class="form-control" id="dataRetentionDays" 
                                                           min="30" max="3650" value="365">
                                                    <small class="text-muted">系统将自动清理超过此天数的日志记录</small>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <button type="button" class="btn btn-outline-primary" id="repairTablesBtn">
                                                        <i class="bi bi-tools me-1"></i> 修复数据库表
                                                    </button>
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="bi bi-save me-1"></i> 保存设置
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // 加载当前设置
                try {
                    const result = await AdminAPI.getSettings();
                    if (result.success) {
                        this.populateSettingsForm(result.settings);
                    }
                } catch (error) {
                    console.error('加载设置失败:', error);
                }
                
                // 绑定修复表按钮事件
                document.getElementById('repairTablesBtn').addEventListener('click', async () => {
                    if (confirm('确定要修复数据库表吗？此操作可能需要一些时间。')) {
                        try {
                            AdminUI.showLoading();
                            const result = await AdminAPI.repairTables();
                            if (result.success) {
                                AdminUI.showToast('数据库表修复成功', 'success');
                            }
                        } catch (error) {
                            AdminUI.showToast('修复数据库表失败: ' + error.message, 'danger');
                        } finally {
                            AdminUI.hideLoading();
                        }
                    }
                });
                
                // 绑定表单提交事件
                document.getElementById('settingsForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const settings = {
                        max_trial_count: parseInt(document.getElementById('maxTrialCount').value),
                        trial_expiry_days: parseInt(document.getElementById('trialExpiryDays').value),
                        registration_enabled: document.querySelector('input[name="registrationEnabled"]:checked').value === 'true',
                        invitation_code_expiry_days: parseInt(document.getElementById('inviteExpiryDays').value),
                        default_max_uses: parseInt(document.getElementById('defaultMaxUses').value),
                        max_generate_count: parseInt(document.getElementById('maxGenerateCount').value),
                        maintenance_mode: document.getElementById('maintenanceMode').checked,
                        data_retention_days: parseInt(document.getElementById('dataRetentionDays').value)
                    };
                    
                    try {
                        AdminUI.showLoading();
                        const result = await AdminAPI.updateSettings(settings);
                        if (result.success) {
                            AdminUI.showToast('系统设置已保存', 'success');
                        }
                    } catch (error) {
                        AdminUI.showToast('保存设置失败: ' + error.message, 'danger');
                    } finally {
                        AdminUI.hideLoading();
                    }
                });
            },
            
            populateSettingsForm(settings) {
                if (settings.max_trial_count) {
                    document.getElementById('maxTrialCount').value = settings.max_trial_count;
                }
                if (settings.invitation_code_expiry_days) {
                    document.getElementById('inviteExpiryDays').value = settings.invitation_code_expiry_days;
                }
                if (settings.max_generate_count) {
                    document.getElementById('maxGenerateCount').value = settings.max_generate_count;
                }
                if (settings.data_retention_days) {
                    document.getElementById('dataRetentionDays').value = settings.data_retention_days;
                }
                if (settings.registration_enabled !== undefined) {
                    document.getElementById(settings.registration_enabled ? 'regEnabled' : 'regDisabled').checked = true;
                }
                if (settings.maintenance_mode !== undefined) {
                    document.getElementById('maintenanceMode').checked = settings.maintenance_mode;
                }
            },
            
            renderPagination(containerId, pagination, pageChangeCallback) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                if (!pagination || pagination.totalPages <= 1) {
                    container.innerHTML = '';
                    return;
                }
                
                let html = '<nav><ul class="pagination pagination-sm">';
                
                // 上一页按钮
                html += `
                    <li class="page-item ${pagination.hasPrev ? '' : 'disabled'}">
                        <a class="page-link" href="#" ${pagination.hasPrev ? `onclick="event.preventDefault(); ${pageChangeCallback.name}(${pagination.page - 1})"` : ''}>
                            &laquo;
                        </a>
                    </li>
                `;
                
                // 页码按钮
                const maxVisible = 5;
                let startPage = Math.max(1, pagination.page - Math.floor(maxVisible / 2));
                let endPage = Math.min(pagination.totalPages, startPage + maxVisible - 1);
                
                if (endPage - startPage + 1 < maxVisible) {
                    startPage = Math.max(1, endPage - maxVisible + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    html += `
                        <li class="page-item ${i === pagination.page ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="event.preventDefault(); ${pageChangeCallback.name}(${i})">
                                ${i}
                            </a>
                        </li>
                    `;
                }
                
                // 下一页按钮
                html += `
                    <li class="page-item ${pagination.hasNext ? '' : 'disabled'}">
                        <a class="page-link" href="#" ${pagination.hasNext ? `onclick="event.preventDefault(); ${pageChangeCallback.name}(${pagination.page + 1})"` : ''}>
                            &raquo;
                        </a>
                    </li>
                `;
                
                html += '</ul></nav>';
                container.innerHTML = html;
            }
        };

        // ==================== 事件处理 ====================
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化状态
            const isAuthenticated = AdminState.init();
            
            if (isAuthenticated) {
                AdminUI.showAdminDashboard();
            } else {
                AdminUI.showLoginPage();
            }
            
            // 登录表单提交
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('adminUsername').value.trim();
                const password = document.getElementById('adminPassword').value;
                
                if (!username || !password) {
                    AdminUI.showAlert('请输入用户名和密码');
                    return;
                }
                
                const loginBtn = document.querySelector('#loginForm button[type="submit"]');
                const loginBtnText = document.getElementById('loginBtnText');
                const loginLoading = document.getElementById('loginLoading');
                
                loginBtn.disabled = true;
                loginBtnText.textContent = '登录中...';
                loginLoading.classList.remove('d-none');
                
                try {
                    const result = await AdminAPI.login(username, password);
                    
                    if (result.success) {
                        AdminUI.showAdminDashboard();
                    } else {
                        AdminUI.showAlert(result.error || '登录失败');
                    }
                } catch (error) {
                    AdminUI.showAlert('登录失败: ' + error.message);
                } finally {
                    loginBtn.disabled = false;
                    loginBtnText.textContent = '登录';
                    loginLoading.classList.add('d-none');
                }
            });
            
            // 侧边栏导航
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.dataset.section;
                    AdminUI.showSection(sectionId);
                });
            });
            
            // 退出登录
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('确定要退出登录吗？')) {
                    AdminState.clearAuth();
                    AdminUI.showLoginPage();
                }
            });
            
            // 刷新统计
            document.getElementById('refreshStats').addEventListener('click', function() {
                AdminUI.loadDashboard();
            });
            
            // 生成邀请码按钮
            document.getElementById('generateInvitesBtn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('generateInvitesModal'));
                modal.show();
            });
            
            // 查看申请按钮
            document.getElementById('viewAppsBtn').addEventListener('click', function() {
                AdminUI.showSection('applications');
            });
            
            // 系统日志按钮
            document.getElementById('systemLogsBtn').addEventListener('click', function() {
                AdminUI.showSection('logs');
            });
            
            // 导出数据按钮
            document.getElementById('exportDataBtn').addEventListener('click', function() {
                AdminUI.showToast('导出数据功能开发中...', 'info');
            });
            
            // 确认生成邀请码
            document.getElementById('confirmGenerateBtn').addEventListener('click', async function() {
                const count = parseInt(document.getElementById('inviteCount').value);
                const purpose = document.getElementById('invitePurpose').value.trim();
                const expiryDays = parseInt(document.getElementById('expiryDays').value);
                const maxUses = parseInt(document.getElementById('maxUses').value);
                
                if (!purpose) {
                    AdminUI.showToast('请填写用途说明', 'warning');
                    return;
                }
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('generateInvitesModal'));
                
                try {
                    AdminUI.showLoading();
                    
                    const result = await AdminAPI.generateInvitationCodes({
                        count,
                        purpose,
                        expiryDays,
                        maxUses,
                        createdBy: AdminState.adminInfo.username,
                        format: 'json'
                    });
                    
                    if (result.success) {
                        AdminUI.showToast(`成功生成 ${result.count || result.codes.length} 个邀请码！`, 'success');
                        modal.hide();
                        
                        // 重置表单
                        document.getElementById('generateInvitesForm').reset();
                        
                        // 刷新邀请码列表
                        AdminUI.loadInvitations();
                    } else {
                        AdminUI.showToast('生成失败: ' + result.error, 'danger');
                    }
                } catch (error) {
                    AdminUI.showToast('生成失败: ' + error.message, 'danger');
                } finally {
                    AdminUI.hideLoading();
                }
            });
            
            // 初始化显示控制面板
            AdminUI.showSection('dashboard');
            
            // 添加搜索框实时搜索功能
            document.addEventListener('input', function(e) {
                if (e.target.id === 'userSearch') {
                    // 防抖处理，延迟500ms执行搜索
                    clearTimeout(window.searchTimeout);
                    window.searchTimeout = setTimeout(() => {
                        const search = e.target.value;
                        AdminUI.loadUsers(1, search);
                    }, 500);
                }
                
                if (e.target.id === 'recordSearch') {
                    clearTimeout(window.recordSearchTimeout);
                    window.recordSearchTimeout = setTimeout(() => {
                        AdminUI.loadRecords(1);
                    }, 500);
                }
            });
            
            // 添加回车键搜索功能
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    if (e.target.id === 'userSearch') {
                        const search = e.target.value;
                        AdminUI.loadUsers(1, search);
                    }
                    
                    if (e.target.id === 'recordSearch') {
                        AdminUI.loadRecords(1);
                    }
                }
            });
            
            // 添加刷新按钮事件
            document.addEventListener('click', function(e) {
                if (e.target.id === 'refreshUsers' || e.target.closest('#refreshUsers')) {
                    const search = document.getElementById('userSearch')?.value || '';
                    AdminUI.loadUsers(1, search);
                }
                
                if (e.target.id === 'refreshRecords' || e.target.closest('#refreshRecords')) {
                    AdminUI.loadRecords(1);
                }
                
                if (e.target.id === 'refreshLogs' || e.target.closest('#refreshLogs')) {
                    AdminUI.loadLogs(1);
                }
            });
        });
    </script>
</body>
</html>
